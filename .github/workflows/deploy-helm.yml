name: Deploy All Helm Charts

on:
  push:
    branches: [ "main" ]
    paths:
      - 'helm/**'

jobs:
  # JOB 1: Find all charts in the directory
  discover-charts:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Discover Charts
        id: set-matrix
        run: |
          CHARTS=$(find helm -mindepth 1 -maxdepth 1 -type d -exec test -e '{}/Chart.yaml' \; -print | xargs -n 1 basename | jq -R -s -c 'split("\n")[:-1]')
          echo "Found charts: $CHARTS"
          echo "matrix=$CHARTS" >> $GITHUB_OUTPUT

  # JOB 2: Run deployment for EACH chart found
  deploy:
    needs: discover-charts
    runs-on: arc-runner-set
    strategy:
      fail-fast: false # If one fails, don't stop the others
      matrix:
        chart: ${{ fromJson(needs.discover-charts.outputs.matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      # --- DYNAMIC SECRET HANDLING ---
      # Problem: Different charts need different secrets.
      # Solution: We run a setup script IF it exists in the chart folder.
      - name: Pre-Install Setup (Secrets)
        env:
          # Pass ALL secrets. The script will pick what it needs.
          AUTH0_CID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CSEC: ${{ secrets.AUTH0_CLIENT_SECRET }}
          # Add other future secrets here...
        run: |
          SETUP_SCRIPT="./helm/${{ matrix.chart }}/setup.sh"
          if [ -f "$SETUP_SCRIPT" ]; then
            echo "üîß Found setup script for ${{ matrix.chart }}, executing..."
            chmod +x "$SETUP_SCRIPT"
            $SETUP_SCRIPT
          else
            echo "‚ÑπÔ∏è No setup.sh found for ${{ matrix.chart }}, skipping pre-install."
          fi

      # --- GENERIC DEPLOYMENT ---
      - name: Deploy ${{ matrix.chart }}
        run: |
          CHART_PATH="./helm/${{ matrix.chart }}"
          
          echo "üì¶ Building dependencies for $CHART_PATH..."
          helm dependency build $CHART_PATH

          echo "üöÄ Deploying ${{ matrix.chart }}..."
          # We use the folder name as the Release Name (camunda-wrapper)
          # We map it to a namespace matching the name (optional, or stick to a fixed one)
          
          helm upgrade --install ${{ matrix.chart }} $CHART_PATH \
            --namespace camunda \
            --create-namespace \
            --wait \
            --timeout 15m